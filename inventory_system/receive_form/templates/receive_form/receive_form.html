{% extends "base.html" %} {% block content %}
<style>
  /* Import Poppins font */
  @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap");

  /* General styles */
  body {
    font-family: "Poppins", sans-serif;
  }

  .container {
    background-color: #f8f9fa;
    padding: 20px;
    min-height: 100vh;
  }

  .form-container {
    max-width: 800px;
    margin: 0 auto;
    background-color: #ffffff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-title {
    margin-bottom: 25px;
    font-weight: 500;
    color: #333;
    font-family: "Poppins", sans-serif;
  }

  /* Form elements */
  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: #333;
    font-weight: 400;
  }

  .form-control {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    font-family: "Poppins", sans-serif;
  }

  .form-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px;
    font-family: "Poppins", sans-serif;
  }

  .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .scan-btn {
    background-color: #0d6efd;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    font-size: 14px;
    font-family: "Poppins", sans-serif;
    background-color: #307634;
  }

  .scan-btn i {
    margin-right: 8px;
  }

  .select-position-btn {
    white-space: nowrap;
    padding: 10px;
    background-color: #f8f9fa;
    color: #333;
    border: 1px solid #ced4da;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: "Poppins", sans-serif;
    background-color: #307634;
    color: white;
  }

  .submit-btn {
    background-color: #0d6efd;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-family: "Poppins", sans-serif;
    background-color: #307634;
  }

  .qr-reader {
    width: 100%;
    max-width: 500px;
    margin: 15px auto 0;
    display: none;
  }

  .scan-result {
    margin-top: 10px;
    font-weight: bold;
  }

  .text-right {
    text-align: right;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
  }

  .modal-content {
    position: relative;
    width: 90%;
    height: 90%;
    margin: 2% auto;
    background-color: #fff;
    padding: 20px;
    box-sizing: border-box;
    overflow: hidden;
    border-radius: 8px;
  }

  .modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    background-color: #0d6efd;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .modal-iframe {
    width: 100%;
    height: calc(100% - 40px);
    border: none;
    margin-top: 40px;
    display: none;
  }

  /* Tab styles */
  .warehouse-tabs {
    display: flex;
    margin-top: 10px;
    margin-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
  }

  .warehouse-tab {
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid transparent;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
    margin-right: 5px;
    position: relative;
    top: 1px;
    font-family: "Poppins", sans-serif;
  }

  .warehouse-tab:hover {
    background-color: #f8f9fa;
  }

  .warehouse-tab.active {
    border-color: #dee2e6 #dee2e6 #fff;
    background-color: #fff;
    color: #307634;
    font-weight: 600;
  }

  /* Confirmation modal styles */
  .confirmation-modal {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
  }

  .confirmation-content {
    position: relative;
    width: 90%;
    max-width: 600px;
    margin: 10% auto;
    background-color: #fff;
    padding: 30px;
    box-sizing: border-box;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .confirmation-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    color: #307634;
  }

  .confirmation-header i {
    font-size: 32px;
    margin-right: 15px;
  }

  .confirmation-header h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }

  .confirmation-details {
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    background-color: #f8f9fa;
  }

  .detail-row {
    display: flex;
    margin-bottom: 10px;
  }

  .detail-label {
    width: 40%;
    font-weight: 500;
    color: #495057;
  }

  .detail-value {
    width: 60%;
    color: #212529;
  }

  .confirmation-footer {
    text-align: center;
  }

  .confirmation-button {
    background-color: #307634;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    font-family: "Poppins", sans-serif;
  }
</style>

<div class="container">
  <div class="form-container">
    <h2 class="form-title">RECEIVING STOCK DATA ENTRY</h2>

    <!-- QR Code Scanner Button -->
    <div class="form-group">
      <button id="scanButton" class="scan-btn">
        <i class="fas fa-qrcode"></i> Scan QR Code
      </button>
      <div id="reader" class="qr-reader"></div>
      <div id="scanResult" class="scan-result"></div>
    </div>

    <form method="post" action="" id="stockForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="production_id" class="form-label"
          >Production Code* (Enter a number)</label
        >
        <input
          type="text"
          id="production_id"
          name="production_id"
          placeholder="e.g., 001-3-24S04"
          class="form-control"
          required
        />
      </div>

      <div class="form-group">
        <label for="product_received" class="form-label">Product*</label>
        <select
          id="product_received"
          name="product_received"
          class="form-select"
          required
        >
          <option value="" selected disabled>Choose an option</option>
          <option value="Trolley">Trolley</option>
          <option value="Armchair">Armchair</option>
          <option value="Pallets">Pallets</option>
        </select>
      </div>

      <div class="form-group">
        <label for="color" class="form-label">Color*</label>
        <select id="color" name="color" class="form-select" required>
          <option value="" selected disabled>Choose an option</option>
          <option value="green">Green</option>
          <option value="black">Black</option>
          <option value="orange">Orange</option>
        </select>
      </div>

      <div class="form-group">
        <label for="status" class="form-label">Status*</label>
        <select id="status" name="status" class="form-select" required>
          <option value="" selected disabled>Select Status</option>
          <option value="NEW">NEW</option>
          <option value="REFORMED">REFORMED</option>
        </select>
      </div>

      <div class="form-group">
        <label for="quantity" class="form-label">Quantity</label>
        <input
          type="number"
          id="quantity"
          name="quantity"
          value="0"
          min="0"
          class="form-control"
          required
        />
      </div>

      <div class="form-group">
        <label for="pallet_position" class="form-label"
          >Pallet Position No.*</label
        >
        <div class="input-group">
          <input
            type="text"
            id="pallet_position"
            name="pallet_position"
            placeholder="e.g., 0040"
            class="form-control"
            required
            readonly
          />
          <button
            type="button"
            id="selectPalletButton"
            class="select-position-btn"
          >
            Select Position
          </button>
        </div>
      </div>

      <div class="form-group">
        <label for="date" class="form-label">Date</label>
        <input
          type="date"
          id="date"
          name="date"
          value="{% now 'Y-m-d' %}"
          class="form-control"
          required
        />
      </div>

      <div class="text-right">
        <button type="submit" class="submit-btn">Submit Entry</button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
{% if success_data %}
<div class="confirmation-modal" id="confirmationModal">
  <div class="confirmation-content">
    <div class="confirmation-header">
      <i class="fas fa-check-circle"></i>
      <h3>Stock Entry Successful</h3>
    </div>

    <div class="confirmation-details">
      <div class="detail-row">
        <div class="detail-label">Production ID:</div>
        <div class="detail-value">{{ success_data.production_id }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Product:</div>
        <div class="detail-value">{{ success_data.product }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Color:</div>
        <div class="detail-value">{{ success_data.color }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Status:</div>
        <div class="detail-value">{{ success_data.status }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Quantity:</div>
        <div class="detail-value">{{ success_data.quantity }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Pallet Position:</div>
        <div class="detail-value">{{ success_data.pallet_position }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Warehouse ID:</div>
        <div class="detail-value">{{ success_data.warehouse_id }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Item Code:</div>
        <div class="detail-value">{{ success_data.item_code }}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Date:</div>
        <div class="detail-value">{{ success_data.date }}</div>
      </div>
    </div>

    <div class="confirmation-footer">
      <button class="confirmation-button" id="confirmationCloseBtn">
        Continue
      </button>
    </div>
  </div>
</div>
{% endif %}

<!-- Include Font Awesome for the QR code icon -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<!-- Include the html5-qrcode library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
<script>
  // Consolidate all DOM ready code into a single event listener
  document.addEventListener("DOMContentLoaded", function () {
    // QR Code Scanner functionality
    const scanButton = document.getElementById("scanButton");
    const readerDiv = document.getElementById("reader");
    const scanResult = document.getElementById("scanResult");
    let html5QrCode;

    // Initialize reader div with display: none
    readerDiv.style.display = "none";

    scanButton.addEventListener("click", function () {
      if (readerDiv.style.display === "none") {
        // Show the scanner
        readerDiv.style.display = "block";
        scanButton.innerHTML = '<i class="fas fa-times"></i> Cancel Scan';

        // Initialize the scanner
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        html5QrCode
          .start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
          )
          .catch((error) => {
            console.error("QR Scanner initialization error:", error);
            scanResult.textContent =
              "Failed to start scanner. Please check camera permissions.";
            stopScanner();
          });
      } else {
        // Hide the scanner
        stopScanner();
      }
    });

    const stockForm = document.getElementById("stockForm");
    stockForm.addEventListener("submit", function (event) {
      const palletPositionInput = document.getElementById("pallet_position");
      const palletPositionValue = palletPositionInput.value.trim();

      if (palletPositionValue === "") {
        event.preventDefault();

        // Create error message element if it doesn't exist
        let errorMsg = document.getElementById("pallet-position-error");
        if (!errorMsg) {
          errorMsg = document.createElement("div");
          errorMsg.id = "pallet-position-error";
          errorMsg.className = "error-message";
          errorMsg.style.color = "red";
          errorMsg.style.fontSize = "0.85rem";
          errorMsg.style.marginTop = "5px";
          palletPositionInput.parentNode.appendChild(errorMsg);
        }

        errorMsg.textContent = "Please select a pallet position";
        palletPositionInput.style.borderColor = "red";

        // Scroll to and focus on the selectPalletButton
        document.getElementById("selectPalletButton").focus();
      }
    });

    // Clear error when user clicks select position button
    document
      .getElementById("selectPalletButton")
      .addEventListener("click", function () {
        const errorMsg = document.getElementById("pallet-position-error");
        if (errorMsg) {
          errorMsg.textContent = "";
        }
        document.getElementById("pallet_position").style.borderColor = "";
      });

    // Form validation for quantity
    stockForm.addEventListener("submit", function (event) {
      const quantityInput = document.getElementById("quantity");
      const quantityValue = parseInt(quantityInput.value);

      if (quantityValue <= 0) {
        event.preventDefault();

        // Create error message element if it doesn't exist
        let errorMsg = document.getElementById("quantity-error");
        if (!errorMsg) {
          errorMsg = document.createElement("div");
          errorMsg.id = "quantity-error";
          errorMsg.className = "error-message";
          errorMsg.style.color = "red";
          errorMsg.style.fontSize = "0.85rem";
          errorMsg.style.marginTop = "5px";
          quantityInput.parentNode.appendChild(errorMsg);
        }

        errorMsg.textContent = "Quantity must be greater than 0";
        quantityInput.style.borderColor = "red";
        quantityInput.focus();
      }
    });

    // Clear error when user starts typing in quantity field
    document.getElementById("quantity").addEventListener("input", function () {
      const errorMsg = document.getElementById("quantity-error");
      if (errorMsg) {
        errorMsg.textContent = "";
      }
      this.style.borderColor = "";
    });

    function onScanSuccess(decodedText, decodedResult) {
      // Stop the scanner
      stopScanner();

      // Display success message
      scanResult.textContent = "QR Code scanned successfully!";

      try {
        // Parse the QR code data (assuming it's in JSON format)
        const data = JSON.parse(decodedText);

        // Fill the form with the scanned data
        if (data.production_id)
          document.getElementById("production_id").value = data.production_id;
        if (data.product) {
          const productSelect = document.getElementById("product_received");
          for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].value === data.product) {
              productSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.color) {
          const colorSelect = document.getElementById("color");
          for (let i = 0; i < colorSelect.options.length; i++) {
            if (colorSelect.options[i].value === data.color) {
              colorSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.status) {
          const statusSelect = document.getElementById("status");
          for (let i = 0; i < statusSelect.options.length; i++) {
            if (statusSelect.options[i].value === data.status) {
              statusSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.quantity)
          document.getElementById("quantity").value = data.quantity;
        if (data.pallet_position)
          document.getElementById("pallet_position").value =
            data.pallet_position;
        if (data.date) document.getElementById("date").value = data.date;
      } catch (error) {
        console.error("Error parsing QR code data:", error);
        scanResult.textContent =
          "Error parsing QR code data. Please try again.";
      }
    }

    function onScanFailure(error) {
      // Handle scan failure silently
      console.warn(`QR code scanning failed: ${error}`);
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode
          .stop()
          .then(() => {
            readerDiv.style.display = "none";
            scanButton.innerHTML = '<i class="fas fa-qrcode"></i> Scan QR Code';
          })
          .catch((err) => {
            console.error("Error stopping scanner:", err);
          });
      }
    }

    // Warehouse Layout Modal functionality
    const palletPositionInput = document.getElementById("pallet_position");
    const selectPalletButton = document.getElementById("selectPalletButton");

    // Create a modal container for the warehouse layout
    const modalContainer = document.createElement("div");
    modalContainer.id = "warehouseLayoutModal";
    modalContainer.className = "modal";

    // Create a modal content container
    const modalContent = document.createElement("div");
    modalContent.className = "modal-content";

    // Create a close button
    const closeButton = document.createElement("button");
    closeButton.textContent = "Close";
    closeButton.className = "modal-close";

    // Create a tabs container
    const tabsContainer = document.createElement("div");
    tabsContainer.className = "warehouse-tabs";

    // Create two tabs
    const insideTab = document.createElement("div");
    insideTab.className = "warehouse-tab active";
    insideTab.id = "tab-inside";
    insideTab.textContent = "Warehouse Area";

    const outsideTab = document.createElement("div");
    outsideTab.className = "warehouse-tab";
    outsideTab.id = "tab-outside";
    outsideTab.textContent = "Warehouse Outside";

    // Add tabs to the tabs container
    tabsContainer.appendChild(insideTab);
    tabsContainer.appendChild(outsideTab);

    // Create iframes for both warehouse layouts
    const insideIframe = document.createElement("iframe");
    insideIframe.id = "warehouseInsideFrame";
    insideIframe.className = "modal-iframe";
    insideIframe.src = "{% url 'receive_form:warehouse_area' %}"; // Update this path to your warehouse area URL
    insideIframe.style.display = "block"; // Start with inside iframe visible

    const outsideIframe = document.createElement("iframe");
    outsideIframe.id = "warehouseOutsideFrame";
    outsideIframe.className = "modal-iframe";
    outsideIframe.src = "{% url 'receive_form:warehouse_outside' %}"; // This matches your existing URL

    // Append everything to the DOM
    modalContent.appendChild(closeButton);
    modalContent.appendChild(tabsContainer);
    modalContent.appendChild(insideIframe);
    modalContent.appendChild(outsideIframe);
    modalContainer.appendChild(modalContent);
    document.body.appendChild(modalContainer);

    // Add event listener to the select button
    selectPalletButton.addEventListener("click", function () {
      modalContainer.style.display = "block";
    });

    // Add event listener to the close button
    closeButton.addEventListener("click", function () {
      modalContainer.style.display = "none";
    });

    // Add event listeners for tab switching
    insideTab.addEventListener("click", function () {
      insideTab.classList.add("active");
      outsideTab.classList.remove("active");
      insideIframe.style.display = "block";
      outsideIframe.style.display = "none";
    });

    outsideTab.addEventListener("click", function () {
      outsideTab.classList.add("active");
      insideTab.classList.remove("active");
      outsideIframe.style.display = "block";
      insideIframe.style.display = "none";
    });

    // Listen for messages from the iframes
    window.addEventListener("message", function (event) {
      if (event.data && event.data.type === "palletSelected") {
        palletPositionInput.value = event.data.palletCode;
        modalContainer.style.display = "none";
      }
    });

    // Confirmation modal functionality
    const confirmationModal = document.getElementById("confirmationModal");
    const confirmationCloseBtn = document.getElementById(
      "confirmationCloseBtn"
    );

    if (confirmationCloseBtn) {
      confirmationCloseBtn.addEventListener("click", function () {
        window.location.href = "{% url 'receive_form:receive_form' %}";
      });
    }
  });
</script>
{% endblock %}
