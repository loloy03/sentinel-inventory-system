{% extends "base.html" %} 
{% block content %} 
{% load static %}
<head>
  <link rel="stylesheet" href="{% static 'css/forms_styles.css' %}" />
</head>

<div class="container">
  <div class="form-container">
    <h2 class="form-title">RELEASE STOCK DATA ENTRY</h2>

    <!-- QR Code Scanner Button -->
    <div class="form-group">
      <button id="scanButton" class="scan-btn">
        <i class="fas fa-qrcode"></i> Scan QR Code
      </button>
      <div id="reader" class="qr-reader"></div>
      <div id="scanResult" class="scan-result"></div>
    </div>

    <form method="post" action="" id="stockForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="production_code" class="form-label"
          >Production Code* (Enter a number)</label
        >
        <input
          type="text"
          id="production_code"
          name="production_code"
          placeholder="e.g., 001-3-24S04"
          class="form-control"
          required
        />
      </div>

      <div class="form-group">
        <label for="product_released" class="form-label">Product*</label>
        <select
          id="product_released"
          name="product_released"
          class="form-select"
          required
        >
          <option value="" selected disabled>Choose an option</option>
          <option value="Trolley">Trolley</option>
          <option value="Armchair">Armchair</option>
          <option value="Pallets">Pallets</option>
        </select>
      </div>

      <div class="form-group">
        <label for="color" class="form-label">Color*</label>
        <select id="color" name="color" class="form-select" required>
          <option value="" selected disabled>Choose an option</option>
          <option value="green">Green</option>
          <option value="black">Black</option>
          <option value="orange">Orange</option>
        </select>
      </div>

      <div class="form-group">
        <label for="status" class="form-label">Status*</label>
        <select id="status" name="status" class="form-select" required>
          <option value="" selected disabled>Select Status</option>
          <option value="DELIVERY">DELIVERY</option>
          <option value="OTHER PROCESSES">OTHER PROCESSES</option>
          <option value="REJECT">REJECT</option>
        </select>
      </div>

      <div class="form-group">
        <label for="quantity" class="form-label">Quantity*</label>
        <div class="input-group">
          <input
            type="number"
            id="quantity"
            name="quantity"
            value="0"
            min="0"
            class="form-control"
            required
          />
          <button type="button" onclick="decrementQuantity()" class="select-position-btn">-</button>
          <button type="button" onclick="incrementQuantity()" class="select-position-btn">+</button>
        </div>
      </div>

      <div class="form-group">
        <label for="pallet_position" class="form-label"
          >Pallet Position No.*</label
        >
        <input
          type="text"
          id="pallet_position"
          name="pallet_position"
          placeholder="e.g., 0040"
          class="form-control"
          required
        />
      </div>

      <div class="form-group">
        <label for="date" class="form-label">Date*</label>
        <input
          type="date"
          id="date"
          name="date"
          value="{% now 'Y-m-d' %}"
          class="form-control"
          required
        />
      </div>

      <div class="text-right">
        <button type="submit" class="submit-btn">Submit Entry</button>
      </div>
    </form>
  </div>
</div>

<!-- Include Font Awesome for the QR code icon -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>

<!-- Include the html5-qrcode library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.4/html5-qrcode.min.js"></script>
<script>
  // Quantity functions
  function incrementQuantity() {
    var quantityInput = document.getElementById('quantity');
    quantityInput.value = parseInt(quantityInput.value) + 1;
  }
  
  function decrementQuantity() {
    var quantityInput = document.getElementById('quantity');
    var currentValue = parseInt(quantityInput.value);
    if (currentValue > 0) {
      quantityInput.value = currentValue - 1;
    }
  }

  // QR Code Scanner functionality
  document.addEventListener('DOMContentLoaded', function() {
    const scanButton = document.getElementById('scanButton');
    const readerDiv = document.getElementById('reader');
    const scanResult = document.getElementById('scanResult');
    let html5QrCode;

    // Initialize reader div with display: none
    readerDiv.style.display = "none";

    scanButton.addEventListener('click', function() {
      if (readerDiv.style.display === 'none') {
        // Show the scanner
        readerDiv.style.display = 'block';
        scanButton.innerHTML = '<i class="fas fa-times"></i> Cancel Scan';
        
        // Initialize the scanner
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start(
          { facingMode: "environment" }, 
          config, 
          onScanSuccess, 
          onScanFailure
        ).catch((error) => {
          console.error("QR Scanner initialization error:", error);
          scanResult.textContent = "Failed to start scanner. Please check camera permissions.";
          stopScanner();
        });
      } else {
        // Hide the scanner
        stopScanner();
      }
    });

    const stockForm = document.getElementById("stockForm");
    stockForm.addEventListener("submit", function (event) {
      const quantityInput = document.getElementById("quantity");
      const quantityValue = parseInt(quantityInput.value);

      if (quantityValue <= 0) {
        event.preventDefault();

        // Create error message element if it doesn't exist
        let errorMsg = document.getElementById("quantity-error");
        if (!errorMsg) {
          errorMsg = document.createElement("div");
          errorMsg.id = "quantity-error";
          errorMsg.className = "error-message";
          errorMsg.style.color = "red";
          errorMsg.style.fontSize = "0.85rem";
          errorMsg.style.marginTop = "5px";
          quantityInput.parentNode.appendChild(errorMsg);
        }

        errorMsg.textContent = "Quantity must be greater than 0";
        quantityInput.style.borderColor = "red";
        quantityInput.focus();
      }
    });

    // Clear error when user starts typing in quantity field
    document.getElementById("quantity").addEventListener("input", function () {
      const errorMsg = document.getElementById("quantity-error");
      if (errorMsg) {
        errorMsg.textContent = "";
      }
      this.style.borderColor = "";
    });

    function onScanSuccess(decodedText, decodedResult) {
      // Stop the scanner
      stopScanner();
      
      // Display success message
      scanResult.textContent = "QR Code scanned successfully!";
      
      try {
        // Parse the QR code data (assuming it's in JSON format)
        const data = JSON.parse(decodedText);
        
        // Fill the form with the scanned data
        if (data.production_code) 
          document.getElementById('production_code').value = data.production_code;
        if (data.product) {
          const productSelect = document.getElementById('product_released');
          for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].value === data.product) {
              productSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.color) {
          const colorSelect = document.getElementById('color');
          for (let i = 0; i < colorSelect.options.length; i++) {
            if (colorSelect.options[i].value === data.color) {
              colorSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.status) {
          const statusSelect = document.getElementById('status');
          for (let i = 0; i < statusSelect.options.length; i++) {
            if (statusSelect.options[i].value === data.status) {
              statusSelect.selectedIndex = i;
              break;
            }
          }
        }
        if (data.quantity) 
          document.getElementById('quantity').value = data.quantity;
        if (data.pallet_position) 
          document.getElementById('pallet_position').value = data.pallet_position;
        if (data.date) 
          document.getElementById('date').value = data.date;
        
      } catch (error) {
        console.error("Error parsing QR code data:", error);
        scanResult.textContent = "Error parsing QR code data. Please try again.";
      }
    }

    function onScanFailure(error) {
      // Handle scan failure silently
      console.warn(`QR code scanning failed: ${error}`);
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = 'none';
          scanButton.innerHTML = '<i class="fas fa-qrcode"></i> Scan QR Code';
        }).catch(err => {
          console.error("Error stopping scanner:", err);
        });
      }
    }
  });
</script>
{% endblock %}